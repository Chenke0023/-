name: Daily News Filter

on:
  schedule:
    - cron: "0 1 * * *" # 09:00 Asia/Shanghai
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run filter
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || 'https://ai.hybgzs.com/v1' }}
          MODEL_NAME: ${{ secrets.MODEL_NAME || 'gemini-3-flash-preview' }}
          BATCH_SIZE: ${{ secrets.BATCH_SIZE || '50' }}
          BATCH_DELAY: ${{ secrets.BATCH_DELAY || '10' }}
          REQUEST_DELAY: ${{ secrets.REQUEST_DELAY || '0.2' }}
        run: python batch_process_railway.py

      - name: Pick output files
        id: out
        shell: bash
        run: |
          set -euo pipefail
          md=$(ls -1t 相关新闻_*.md | head -n 1)
          js=$(ls -1t filtered_news_*.json | head -n 1)
          unk=$(ls -1t unknown_news_*.json 2>/dev/null | head -n 1 || true)
          echo "md=$md" >> "$GITHUB_OUTPUT"
          echo "json=$js" >> "$GITHUB_OUTPUT"
          if [ -n "$unk" ]; then
            echo "unknown=$unk" >> "$GITHUB_OUTPUT"
          fi

      - name: Build issue body
        id: body
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os
          import pathlib
          import textwrap

          md_path = pathlib.Path(os.environ["MD_PATH"]).resolve()
          js_path = pathlib.Path(os.environ["JSON_PATH"]).resolve()
          unk_raw = os.environ.get("UNKNOWN_PATH", "")
          unk_path = pathlib.Path(unk_raw).resolve() if unk_raw else None
          md = md_path.read_text(encoding="utf-8", errors="replace")

          max_chars = 60000
          if len(md) > max_chars:
              md = md[:max_chars] + "\n\n... (truncated)\n"

          run_url = os.environ.get("RUN_URL", "")

          unknown_line = ""
          if unk_path and unk_path.exists():
              unknown_line = f"- Unknown: `{unk_path.name}`\n"

          body = textwrap.dedent(f"""\
          Automated daily run finished.

          - Markdown: `{md_path.name}`
          - JSON: `{js_path.name}`
          {unknown_line}- Run: {run_url}
          - Run: {run_url}

          ---

          {md}
          """)

          pathlib.Path("issue_body.txt").write_text(body, encoding="utf-8")
          PY
        env:
          MD_PATH: ${{ steps.out.outputs.md }}
          JSON_PATH: ${{ steps.out.outputs.json }}
          UNKNOWN_PATH: ${{ steps.out.outputs.unknown }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Create or update issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const title = 'Daily News Filter Result';
            const body = fs.readFileSync('issue_body.txt', 'utf8');

            const { owner, repo } = context.repo;
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });

            const existing = issues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.update({ owner, repo, issue_number: existing.number, body });
              core.info(`Updated issue #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({ owner, repo, title, body });
              core.info(`Created issue #${created.data.number}`);
            }

      - name: Upload artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: news-result
          if-no-files-found: ignore
          path: |
            ${{ steps.out.outputs.md }}
            ${{ steps.out.outputs.json }}
            unknown_news_*.json
